<!DOCTYPE html>
<html>

<link rel="stylesheet"
      href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.12.0/build/styles/default.min.css">
<script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.12.0/build/highlight.min.js"></script>


  <head>
    <base target="_top">
  </head>
  <body>
  
  <? var url = getScriptUrl()?>
  
  <a href = "<?=url?>?page=howto">HOW TO</a>
  <br>
  <a href = "<?=url?>?page=monitor">MONITOR</a>
  <br>
  
   <p>Please insert your email address: </p>
   
   <input id="email" type="text">
   
   <p id="emailErMsg" style="color:red"></p>
   
   
   <br>
   <button onClick="getSpecificQuery(); resetEntryBoxes()">Generate query</button>
   
   
   <p id="indexErMsg" style="color:red"></p>
   
   
   <p> SQL: </p>
   <pre><code class="sql" id="sql_plain"></code></pre>
   
   <a id="link"></a>
   
   <p>Entries:</p>
    
   <textarea rows="4" cols="50" id="entry1"></textarea><br>
   <br>
   <textarea rows="4" cols="50" id="entry2"></textarea><br>
   <br>
   <textarea rows="4" cols="50" id="entry3"></textarea><br>
   <br>
   <textarea rows="4" cols="50" id="entry4"></textarea><br>
   <br>
   
   
   <button onClick="tryToSubmit()">Submit</button>
   <br>
   <p id="noSubs"></p>
    
  </body>
  

</html>

<script>

var noSubs = 0

var emailRegExp = /^\S+@\S+\.\S+$/
var emailState = 'empty'
var email = ''

var index
var indexState = 'none'
var indexChange = false

var emptyQuery = {index: 0, sql_plain: '', url: ''}
var query = emptyQuery


var noQueries
google.script.run.withFailureHandler(onFailure)
                            .withSuccessHandler(setNoQueries)
                            .getNoQueries()
                            
function setNoQueries(n)
{
 noQueries = n
}

function onFailure(error)
{
 console.info("ERROR: " + error.message)
}



window.setInterval(routine,500)



function sleep(ms) 
{
  return new Promise(resolve => setTimeout(resolve, ms));
}

function resetEntryBoxes()
{
 document.getElementById('entry1').value = ''
 document.getElementById('entry2').value = ''
 document.getElementById('entry3').value = ''
 document.getElementById('entry4').value = ''
}

function checkEmail()
{
  email = document.getElementById("email").value
  
  if(email == '')emailState = 'empty'
  else if(emailRegExp.test(email) == true)emailState = 'valid'
  else emailState = 'invalid'
  
  var emailErMsg
  if(emailState == 'invalid')
   emailErMsg = 'Email address must be valid.'
  else emailErMsg = ''
  
  document.getElementById("emailErMsg").innerHTML = emailErMsg
 }
 
 async function checkIndex()
 {
   if(indexState == 'valid' && index != query.index)
   {
    var signal = []
    google.script.run.withSuccessHandler(setQuery).withUserObject(signal).getQuery(index)
    while(signal.length == 0){await sleep(100)}
   }
   
   if(indexState == 'valid')
   {
    document.getElementById("link").innerHTML = 'Test the query here'
    document.getElementById("sql_plain").innerHTML = query.sql_plain
    hljs.highlightBlock( document.getElementById("sql_plain") )
    document.getElementById("link").href = query.url
   }
   else
   {
    document.getElementById("link").innerHTML = ''
    document.getElementById("sql_plain").innerHTML = ''
   }
 }
 
 function setQuery(q, signal)
 {
  query = q
  signal.push(0)
 }
   


function routine()
{
  checkEmail()
  
  checkIndex()
}

async function tryToSubmit()
{
 if(emailState != 'valid')
 {
  alert("Please enter a valid email address")
  return
 }
 
 if(indexState != 'valid')
 {
  alert('Please press the "Generate query" button')
  return
 }
 
 var entries = []
 var entry
 
 entry = document.getElementById("entry1").value
 if(entry != '')entries.push(entry)
 entry = document.getElementById("entry2").value
 if(entry != '')entries.push(entry)
 entry = document.getElementById("entry3").value
 if(entry != '')entries.push(entry)
 entry = document.getElementById("entry4").value
 if(entry != '')entries.push(entry)
 
 if(entries.length == 0)
 {
   alert('You must enter at least one entry')
   return
 }
 
 var signal = []
 google.script.run.withSuccessHandler(passSignal).withUserObject(signal).submit(email, index, entries)
 while(signal.length == 0){await sleep(100)}
 alert("Your submission has been sent")
 noSubs++
 document.getElementById("noSubs").innerHTML = 'Number of submissions: ' + String(noSubs)
 getSpecificQuery()
 resetEntryBoxes()
}

async function getSpecificQuery()
{
 var signal = []
 google.script.run.withSuccessHandler(setQuery).withUserObject(signal).getSpecificQuery()
 while(signal.length == 0){await sleep(50)}
 index = query.index
 indexState = 'valid'
}

function passSignal(a, b)
{
 b.push(a)
}

</script>
